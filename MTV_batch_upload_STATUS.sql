select X.BatchName, X.TotalDocs,
X.TotalDocsUploaded, max(X.LastUploadDateTime) LastUploadDateTime,
max(X.LastUploadAttempt) LastUploadAttempt
FROM
(select distinct T.BatchName, T.TotalDocs, 
T.TotalDocsUploaded, max(T.LastUploadDateTime) LastUploadDateTime,
CASE
	When T.TotalDocs <> T.TotalDocsUploaded then max(T.LastUploadAttempt)
	END
	LastUploadAttempt
FROM
(select distinct pbatch BatchName, 
count(distinct d.ImageID) TotalDocs, 
count(distinct ftpstime) TotalDocsUploaded,
max(ftpstime) LastUploadDateTime,
CASE 
	When f.imageid is not null then max(f.insertdate)
	END LastUploadAttempt
from document d
left join FTPError f
on d.ImageID = f.imageid
where pbatch in (
'02202671204710',
'02202881128702',
'02202881803501',
'02202931114704',
'02203001117434',
'02203001216905',
'02203011202111',
'02203021204815',
'02203031102718',
'02203031103309',
'02203031807409',
'02203071111926',
'02203071801207',
'02203081842209',
'02203081842228',
'02203081843410',
'02203081845502',
'02203081847309',
'02203091100512',
'02203091201704',
'02203091800308',
'02203091825204',
'02203091835429',
'02203101828227',
'02203101840901',
'02203101848518',
'02203101850217',
'02203101851910',
'02203101853321',
'02203111107517',
'02203111107518',
'02203111108533',
'02203111108722',
'02203111108723',
'02203111112611',
'02203111112620',
'02203111113212',
'02203111115112',
'02203111127701',
'02203111212319',
'02203111212320',
'02203111213202',
'02203111215906',
'02203111215909',
'02203111216708',
'02203111216711',
'02203111217127',
'02203111217712',
'02203111233403',
'02203111813032',
'02203111813715',
'02203111842816',
'02203111844311',
'02203111844511',
'02203111846120',
'02203111847324',
'02203111847701',
'02203121800316',
'02203121800931',
'02203121800932',
'02203121801104',
'02203121801317',
'02203121801502',
'02203151738901',
'02203171717601',
'02203171722401',
'02203181102201',
'02203181702401',
'02203181737801',
'02203191110701',
'02203191117301',
'02203191707701',
'02203191810501',
'02203191811901',
'02203211709301',
'02203211802301',
'02203211807301',
'02203211809901',
'02203211817101',
'02203221816801',
'02203221823701',
'02203231109301',
'02203231804601',
'02203231841001',
'02203231842001',
'02203241713501',
'02203241801601',
'02203241820701',
'02203251207401',
'02203251813401',
'02203251813801',
'02203251817301',
'02203251843001',
'02203251846901',
'02203251848101',
'02203271214801',
'02203271215801',
'02203271818501',
'02203271823901',
'02203271841301',
'02203271844701') 
group by pbatch, f.imageid) T
group by T.BatchName, T.TotalDocs, T.TotalDocsUploaded, T.LastUploadDateTime) X
group by X.BatchName, X.TotalDocs, X.TotalDocsUploaded, X.LastUploadAttempt
order by X.BatchName

--select * from document where pbatch = '02202671204710'